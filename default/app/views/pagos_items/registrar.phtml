<?= View::content() ?>
<?= Form::open('pagos_items/registrar', 'class="needs-validation" novalidate') ?>

<h1 class="mb-4">Registrar Pago</h1>

<div class="row">
    <div class="col-md-12">
        <div class="form-group">
            <label for="venta_id">Venta</label>
            <select name="pagos_items[venta_id]" class="form-control" required>
                <option value="">Seleccione una venta</option>
                <?php foreach ($ventas as $venta):
                    $adeudo = is_numeric($venta->cliente_adeudo) ? (float)$venta->cliente_adeudo : 0;
                    ?>
                    <option value="<?= $venta->id ?>"
                            data-adeudo="<?= $adeudo ?>">
                        Venta #<?= $venta->id ?> - <?= $venta->cliente_nombre ?>
                    </option>
                <?php endforeach ?>
            </select>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-6">
        <div class="form-group">
            <label>Adeudo Actual</label>
            <input type="text" class="form-control bg-light"
                   id="adeudo_actual" readonly>
        </div>
    </div>
    <div class="col-md-6">
        <div class="form-group">
            <label>Monto Pagado (automático)</label>
            <input type="text" class="form-control bg-light" id="monto_pagado" readonly>
        </div>
    </div>



</div>

<div class="form-group mt-4">
    <?= Form::submit('Registrar Pago', [
        'class' => 'btn btn-primary btn-lg'
    ]) ?>
    <?= Html::link('pagos_items/index', 'Cancelar', [
        'class' => 'btn btn-secondary btn-lg'
    ]) ?>
</div>

<?= Form::close() ?>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ventaSelect = document.querySelector('[name="pagos_items[venta_id]"]');

        ventaSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                const adeudo = parseFloat(selectedOption.getAttribute('data-adeudo')) || 0;
                document.getElementById('adeudo_actual').value = adeudo.toFixed(2);
                document.getElementById('monto_pagado').max = adeudo;
            }
        });

        // Inicializar validación
        const form = document.querySelector('.needs-validation');
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    function calcularAdeudo() {
        const montoInput = document.getElementById('monto_pagado');
        const adeudoActual = parseFloat(document.getElementById('adeudo_actual').value) || 0;
        let monto = parseFloat(montoInput.value) || 0;

        if (monto > adeudoActual) {
            montoInput.value = adeudoActual.toFixed(2);
        }
    }
</script>